Bootstrap: docker
From: node:18-bullseye

%files
    . /app

%post
    # Install system dependencies
    apt-get update
    apt-get install -y \
        libgtk-3-0 \
        libgbm-dev \
        libnotify-dev \
        libgconf-2-4 \
        libnss3 \
        libxss1 \
        libasound2 \
        libxtst6 \
        xauth \
        xvfb \
        python3 \
        make \
        g++ \
        git \
        bash \
        curl \
        ca-certificates
    
    rm -rf /var/lib/apt/lists/*

    # Set working directory
    cd /app

    # Install Node.js dependencies
    npm ci

    # Build the application
    npm run build

    # Create necessary directories
    mkdir -p /app/data /app/logs /app/config

    # Set proper permissions
    chmod -R 755 /app

%environment
    export NODE_ENV=production
    export DTUI_CONFIG_DIR=/app/data
    export DTUI_LOG_DIR=/app/logs
    export PATH=/app/node_modules/.bin:$PATH
    export ELECTRON_DISABLE_SANDBOX=true
    export DISPLAY=:99

%runscript
    cd /app
    if [ "$1" = "headless" ]; then
        exec xvfb-run -a npm run electron
    elif [ "$1" = "gui" ]; then
        exec npm run electron
    elif [ "$1" = "shell" ]; then
        exec /bin/bash
    else
        exec xvfb-run -a npm run electron
    fi

%startscript
    cd /app
    xvfb-run -a npm run electron &

%test
    cd /app
    node -e "console.log('DTUI2 Singularity container test passed')"
    npm --version
    node --version

%help
    DTUI2 - Claude Code Style AI Terminal

    Usage:
        singularity run dtui2.sif [headless|gui|shell]

    Options:
        headless    Run in headless mode (default)
        gui         Run with GUI (requires X11 forwarding)
        shell       Start interactive shell

    Environment Variables:
        DTUI_CONFIG_DIR    Configuration directory (default: /app/data)
        DTUI_LOG_DIR       Log directory (default: /app/logs)

    Examples:
        # Run in headless mode
        singularity run dtui2.sif headless

        # Run with GUI
        singularity run --bind /tmp/.X11-unix:/tmp/.X11-unix dtui2.sif gui

        # Interactive shell
        singularity run dtui2.sif shell

%labels
    Author kwonah0
    Version v1.3.0
    Description DTUI2 - Claude Code Style AI Terminal for HPC environments