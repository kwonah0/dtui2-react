# DTUI2 제품 요구사항 문서 (PRD)

## 개요
DTUI2는 AI 기반 터미널 인터페이스를 제공하는 Electron 기반의 데스크톱 애플리케이션입니다. 사용자가 자연어로 시스템과 상호작용하고, 실제 셸 명령어를 실행할 수 있는 GUI 환경을 제공합니다.

## 핵심 요구사항

### 1. 셸 에이전트 (Shell Agent)
- **실제 셸 프로세스 실행**: 가짜 셸이 아닌 실제 시스템 셸 프로세스를 사용
- **세션 유지**: !shell 명령어 실행 시 세션이 지속되어야 함 (cd, 환경변수 설정 등이 유지됨)
- **에러 처리**: 명령어 실행 실패 시 적절한 오류 메시지와 종료 코드 표시
- **출력 포맷 설정**: 사용자 설정에 따라 다양한 출력 형식 지원
- **통합 호환성**: 일반 환경과 HPC 환경 모두에서 동작하는 단일 설정
- **내장 기본 설정**: 외부 파일 의존성 없이 코드 내부에 안전한 기본 설정 포함

### 2. 설정 시스템 (Configuration System)
3단계 우선순위 구조로 설정 관리:

1. **환경 변수 (최우선)**: `DTUI_CFG__` 접두사 사용
   - 예: `DTUI_CFG__ai__shell__command=bash`
   - 중첩된 설정은 `__`로 구분

2. **사용자 지정 설정 파일**: `DTUI_USER_CONFIGFILE` 환경 변수로 지정
   - 사용자가 원하는 위치의 설정 파일 사용 가능

3. **내장 기본 설정**: 애플리케이션에 포함된 `dtui.json`
   - 표준 사용자 설정 디렉토리 (~/.config) 사용 안 함

### 3. 출력 형식 설정
다음 설정들이 지원되어야 함:
- `useCodeBlock`: 코드 블록 사용 여부
- `codeBlockSyntax`: 코드 블록 언어 설정 (shell, bash 등)
- 마크다운 렌더링과 일반 텍스트 출력 선택

### 4. 배포 및 호환성
- **AppImage 형태**: 단일 실행 파일로 배포
- **HPC 환경 지원**: RedHat 8, NFS 시스템에서 실행 가능
- **비루트 실행**: root 권한 없이 실행 가능
- **오프라인 실행**: 네트워크 연결 없이 동작

## 기술적 구조

### 아키텍처 개요
```
┌─────────────────────────────────────────┐
│           Electron Main Process         │
│  ┌─────────────────┐ ┌─────────────────┐ │
│  │ Configuration   │ │ Shell Session   │ │
│  │ Management      │ │ Management      │ │
│  └─────────────────┘ └─────────────────┘ │
└─────────────────┬───────────────────────┘
                  │ IPC
┌─────────────────┴───────────────────────┐
│        Electron Renderer Process        │
│  ┌─────────────────┐ ┌─────────────────┐ │
│  │ React Frontend  │ │ AI Agent        │ │
│  │                 │ │ Interface       │ │
│  └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────┘
```

### 핵심 컴포넌트
1. **ElectronShellAIAgent**: IPC를 통한 셸 명령 실행
2. **UniversalConfigService**: nconf 기반 설정 관리
3. **UniversalAgentFactory**: 환경에 따른 에이전트 선택
4. **Persistent Shell Session**: 세션 유지 메커니즘

### !shell 명령어 지원
- 문법: `!shell <command>`
- 예시: `!shell ls -la`, `!shell cd /home/user`
- 세션 유지: 이전 명령어의 환경변수, 작업 디렉토리 등이 유지됨
- 오류 처리: stderr 출력과 종료 코드 표시

## 품질 보증

### GUI 테스트 (Playwright)
다음 시나리오들에 대한 자동화된 테스트:

#### 테스트 환경 도구
- **Xvfb (Virtual X11)**: WSL2 환경에서 headless GUI 테스트 지원
- **Playwright Electron**: Electron 앱 자동화 및 UI 테스트
- **스크린샷 캡처**: 시각적 검증을 위한 자동 스크린샷
- **DISPLAY 환경변수**: `:99` 가상 디스플레이 사용

#### 테스트 시나리오
1. **출력 형식 테스트**:
   - `useCodeBlock: true, codeBlockSyntax: 'shell'`
   - `useCodeBlock: true, codeBlockSyntax: 'bash'`
   - `useCodeBlock: false`

2. **PTY 터미널 출력 테스트**:
   - ANSI 컬러 코드 HTML 변환 검증
   - 멀티컬럼 파일 목록 (`!ls`) 형식 확인
   - 터미널 에뮬레이션 (`script` 명령어) 검증

3. **마크다운 문법 검증**:
   - 잘못된 마크다운 문법 반환 방지
   - 코드 블록 형식 정확성 검증

4. **셸 명령어 테스트**:
   - 성공적인 명령어 실행
   - 실패한 명령어의 에러 표시
   - 세션 유지 확인

#### 테스트 실행 환경
```bash
# Xvfb 실행
export DISPLAY=:99
Xvfb :99 -screen 0 1024x768x24 -ac &

# Playwright 테스트 실행
DISPLAY=:99 npx playwright test
```

### 설정 테스트
- 환경 변수 우선순위 테스트
- 사용자 지정 설정 파일 로딩 테스트
- 기본 설정 폴백 테스트

### 테스트 자동화
- **필수 실행**: 모든 코드 수정 후 반드시 전체 테스트 스위트 실행
- **테스트 스위트 구성**:
  - 단위 테스트 (`npm test`)
  - GUI 테스트 (`npm run test:gui`)
  - 통합 테스트 (`npm run test:all`)
- **환경 호환성 검증**: 동일한 테스트가 일반/HPC 환경 모두에서 통과
- **자동화 체계**: CI/CD 또는 pre-commit hook을 통한 강제 실행

## 사용자 경험

### 주요 시나리오
1. **AI와 대화**: 자연어로 질문하고 응답 받기
2. **셸 명령 실행**: `!shell` 접두사로 시스템 명령어 실행
3. **설정 커스터마이징**: 환경 변수나 설정 파일로 동작 방식 조정

### 인터페이스 요구사항
- 직관적인 채팅 인터페이스
- **멀티라인 입력 지원**: 
  - `Shift+Enter`로 줄바꿈 입력 가능
  - 자동 높이 조절 (최대 200px)
  - Enter: 메시지 전송, Shift+Enter: 새 줄 추가
- **쉘 에이전트 멀티라인 처리**:
  - 입력된 줄바꿈 문자 보존
  - 특수문자 이스케이핑 (`"` → `\"`, `$` → `\$`)
  - template 시스템으로 안전한 명령어 구성
- 명령어 결과의 명확한 구분 표시
- 에러 상황에서의 적절한 피드백

## 제약사항 및 고려사항

### 환경적 제약
- HPC 환경의 보안 정책 (SELinux 등)
- NFS 파일시스템의 권한 제약
- 공유 메모리 접근 제한

### 기술적 고려사항
- Vite 빌드 시스템의 Node.js 모듈 제한
- Chromium의 샌드박스 모드와 보안 설정
- IPC 통신의 성능 최적화

## 성공 지표
- HPC 환경에서 안정적인 실행
- 모든 설정 우선순위가 정확히 동작
- GUI 테스트 100% 통과
- 마크다운 문법 오류 0건
- 테스트 자동화 체계 100% 준수
- 단일 설정으로 양쪽 환경 호환성 달성